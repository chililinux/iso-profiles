insmod part_gpt
insmod part_msdos
insmod font
insmod gfxterm
insmod gfxmenu
insmod png
insmod regexp

set locale_dir=$prefix/locale
set lang=pt_BR
set timeout=30
set default=0
set menu_color_normal=white/black
set menu_color_highlight=black/white

# Variáveis de estado
export GRAPHIC_SERVER="Wayland"
export DRIVER_TYPE="Proprietary Drivers"
export ADVANCED_OPTIONS="Nenhum"

# Configuração do tema
loadfont ($root)/boot/grub/fonts/unicode.pf2
set theme=($root)/boot/grub/themes/ruscher-live/theme.txt
export theme

# Função principal do menu
function mainmenu {
    clear
    menuentry "Start (Automático)" --class start {
        linux /vmlinuz root=/dev/sda1 quiet splash
        initrd /initrd.img
    }

    submenu "Servidor Gráfico: $GRAPHIC_SERVER" --class graphics {
        menuentry "Wayland (Padrão)" --class wayland {
            export GRAPHIC_SERVER="Wayland"
            configfile $prefix/grub.cfg
        }
        menuentry "XOrg" --class xorg {
            export GRAPHIC_SERVER="XOrg"
            configfile $prefix/grub.cfg
        }
    }

    submenu "Drivers: $DRIVER_TYPE" --class driver {
        menuentry "Proprietary Drivers (Modern Nvidia + Broadcom)" --class proprietary {
            export DRIVER_TYPE="Proprietary Drivers"
            configfile $prefix/grub.cfg
        }
        menuentry "Open Source Drivers (Legacy)" --class opensource {
            export DRIVER_TYPE="Open Source Drivers"
            configfile $prefix/grub.cfg
        }
    }

    submenu "Opções Avançadas: $ADVANCED_OPTIONS" --class advanced {
        # Opções dinâmicas
        if [ "$GRAPHIC_SERVER" = "XOrg" ]; then
            menuentry "Configurações XOrg" --class xconfig {
                export ADVANCED_OPTIONS="XOrg Tweaks"
                configfile $prefix/grub.cfg
            }
        fi
        
        if [ "$DRIVER_TYPE" = "Proprietary Drivers" ]; then
            menuentry "Otimizações Nvidia" --class nvidia {
                export ADVANCED_OPTIONS="Nvidia Optimized"
                configfile $prefix/grub.cfg
            }
        }
        
        menuentry "Resetar Configurações" --class reset {
            export GRAPHIC_SERVER="Wayland"
            export DRIVER_TYPE="Proprietary Drivers"
            export ADVANCED_OPTIONS="Nenhum"
            configfile $prefix/grub.cfg
        }
    }

    submenu "Ferramentas" --class tools {
        menuentry "Teste de Memória (memtest86+)" --class memtest {
            linux16 /memtest86+.bin
        }
        
        if [ "$grub_platform" = "efi" ]; then
            menuentry "Configurações UEFI" --class uefi {
                fwsetup
            }
        fi
        
        menuentry "Reiniciar Computador" --class reboot {
            reboot
        }
    }
}

# Inicialização
mainmenu
